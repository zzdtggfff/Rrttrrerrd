<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cyber Runner Classic</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        canvas { display: block; }
        #ui { position: absolute; top: 20px; left: 20px; color: #00ffcc; z-index: 10; pointer-events: none; }
        .stat { font-size: 22px; font-weight: bold; text-shadow: 2px 2px #000; margin-bottom: 10px; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; z-index: 100; }
        .menu-card { background: #1a1a1a; padding: 30px; border-radius: 25px; border: 3px solid #00ffcc; text-align: center; width: 300px; box-shadow: 0 0 20px #00ffcc; }
        h1 { margin-top: 0; color: #00ffcc; letter-spacing: 2px; }
        button { width: 100%; padding: 15px; margin: 10px 0; font-size: 18px; font-weight: bold; border-radius: 50px; border: none; cursor: pointer; text-transform: uppercase; transition: 0.3s; }
        .btn-play { background: #00ffcc; color: #000; }
        .btn-menu { background: #333; color: #fff; }
        .shop-item { display: flex; justify-content: space-between; align-items: center; background: #222; padding: 12px; margin-bottom: 10px; border-radius: 15px; }
        .buy-btn { width: auto; padding: 8px 15px; font-size: 14px; background: #ffcc00; color: #000; border-radius: 8px; }
        .buy-btn:disabled { background: #444; color: #888; }
        .char-item { padding: 15px; background: #222; margin: 10px 0; border-radius: 15px; border: 2px solid transparent; cursor: pointer; }
        .char-item.selected { border-color: #00ffcc; background: #003322; }
        #skateTimer { position: absolute; bottom: 50px; width: 100%; text-align: center; color: #ffcc00; font-weight: bold; font-size: 24px; display: none; z-index: 50; text-shadow: 2px 2px #000; }
    </style>
</head>
<body>

    <div id="ui">
        <div class="stat">МОНЕТЫ: <span id="coinVal">0</span></div>
        <div class="stat">СКЕЙТЫ: <span id="skateVal">0</span></div>
        <div class="stat">СЧЕТ: <span id="scoreVal">0</span></div>
    </div>

    <div id="screen-main" class="overlay">
        <div class="menu-card">
            <h1>CYBER RUN</h1>
            <button class="btn-play" onclick="startGame()">ИГРАТЬ</button>
            <button class="btn-menu" onclick="showScreen('screen-shop')">МАГАЗИН</button>
            <button class="btn-menu" onclick="openCharMenu()">ПЕРСОНАЖИ</button>
        </div>
    </div>

    <div id="screen-shop" class="overlay" style="display:none;">
        <div class="menu-card">
            <h2>МАГАЗИН</h2>
            <div class="stat" style="color:#ffcc00;">БАЛАНС: <span id="shopCoinVal">0</span></div>
            <div class="shop-item"><span>СКЕЙТ (1$)</span><button class="buy-btn" onclick="buySkate()">+1</button></div>
            <div class="shop-item"><span>ДРОИД (5$)</span><button class="buy-btn" id="b-droid" onclick="buyChar('droid', 5)">КУПИТЬ</button></div>
            <div class="shop-item"><span>СПАЙК (10$)</span><button class="buy-btn" id="b-spike" onclick="buyChar('spike', 10)">КУПИТЬ</button></div>
            <button class="btn-menu" onclick="showScreen('screen-main')">НАЗАД</button>
        </div>
    </div>

    <div id="screen-chars" class="overlay" style="display:none;">
        <div class="menu-card">
            <h2>ГЕРОИ</h2>
            <div id="char-list"></div>
            <button class="btn-menu" onclick="showScreen('screen-main')">НАЗАД</button>
        </div>
    </div>

    <div id="skateTimer">СКЕЙТ: <span id="skateSec">30</span>с</div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        let data = { coins: 0, skates: 0, unlocked: { robot: true, droid: false, spike: false }, selected: 'robot' };
        let isPlaying = false, score = 0, speed = 0.5, currentLane = 1;
        let yVel = 0, isJumping = false, skateActive = false, skateTime = 0;
        let lastSpawn = 0, lastTap = 0, obstacles = [], coins = [];

        // Сцена
        const scene = new THREE.Scene();
        scene.fog = new THREE.Fog(0x000000, 15, 90);
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(0, 6, 11); camera.lookAt(0, 2, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        scene.add(new THREE.AmbientLight(0xffffff, 0.7));

        // Персонажи
        const playerGroup = new THREE.Group();
        const models = { robot: new THREE.Group(), droid: new THREE.Group(), spike: new THREE.Group() };
        playerGroup.add(models.robot, models.droid, models.spike);
        scene.add(playerGroup);

        const skateMesh = new THREE.Mesh(new THREE.BoxGeometry(1.6, 0.15, 2.8), new THREE.MeshStandardMaterial({color: 0x00ffcc, emissive: 0x00ffcc}));
        skateMesh.position.y = 0.1; skateMesh.visible = false;
        playerGroup.add(skateMesh);

        function buildModels() {
            const metal = new THREE.MeshStandardMaterial({color: 0x888888});
            const green = new THREE.MeshStandardMaterial({color: 0x2d5a27});

            // Robot
            const rBody = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1, 0.5), metal); rBody.position.y = 1.3;
            const rHead = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.4, 0.4), new THREE.MeshStandardMaterial({color:0x00ffcc})); rHead.position.y = 2.1;
            const rLL = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.8, 0.3), metal); rLL.position.set(-0.25, 0.4, 0);
            const rLR = rLL.clone(); rLR.position.x = 0.25;
            const rAL = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.7, 0.2), metal); rAL.position.set(-0.55, 1.3, 0);
            const rAR = rAL.clone(); rAR.position.x = 0.55;
            models.robot.add(rBody, rHead, rLL, rLR, rAL, rAR);

            // Droid
            const dBody = new THREE.Mesh(new THREE.SphereGeometry(0.6, 16, 16), new THREE.MeshStandardMaterial({color:0x222222, emissive: 0x00ffff}));
            dBody.position.y = 1.1;
            models.droid.add(dBody);

            // Spike
            const sBody = new THREE.Mesh(new THREE.CapsuleGeometry(0.5, 0.8), green); sBody.position.y = 1.1;
            const sLL = new THREE.Mesh(new THREE.BoxGeometry(0.25, 0.6, 0.25), green); sLL.position.set(-0.25, 0.3, 0);
            const sLR = sLL.clone(); sLR.position.x = 0.25;
            const sAL = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.6, 0.2), green); sAL.position.set(-0.6, 1.2, 0); sAL.rotation.z = 0.4;
            const sAR = sAL.clone(); sAR.position.x = 0.6; sAR.rotation.z = -0.4;
            models.spike.add(sBody, sLL, sLR, sAL, sAR);
        }

        const road = new THREE.GridHelper(200, 40, 0x00ffcc, 0x002222);
        scene.add(road);

        function spawn() {
            if (Date.now() - lastSpawn < 600 / speed) return;
            lastSpawn = Date.now();
            const lane = [-3.5, 0, 3.5][Math.floor(Math.random()*3)];
            const r = Math.random();

            if (r < 0.3) {
                const g = new THREE.Group();
                const ramp = new THREE.Mesh(new THREE.BoxGeometry(3, 1, 6), new THREE.MeshStandardMaterial({color: 0x0066ff}));
                ramp.rotation.x = -0.2; ramp.position.set(0, 0.5, 0);
                const plat = new THREE.Mesh(new THREE.BoxGeometry(3.2, 0.4, 10), new THREE.MeshStandardMaterial({color: 0x00ffff}));
                plat.position.set(0, 2.5, -8); plat.isPlatform = true;
                g.add(ramp, plat); g.position.set(lane, 0, -100);
                scene.add(g); obstacles.push(g);
            } else if (r < 0.7) {
                const b = new THREE.Mesh(new THREE.BoxGeometry(2.5, 2, 1), new THREE.MeshStandardMaterial({color: 0xff0044}));
                b.position.set(lane, 1, -100); b.isHurt = true;
                scene.add(b); obstacles.push(b);
            } else {
                const c = new THREE.Mesh(new THREE.TorusGeometry(0.4, 0.1), new THREE.MeshStandardMaterial({color: 0xffff00}));
                c.position.set(lane, 1.2, -100); scene.add(c); coins.push(c);
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            if (!isPlaying) { renderer.render(scene, camera); return; }

            speed += 0.0001;
            let moveSpeed = skateActive ? speed * 1.4 : speed;
            score++;
            document.getElementById('scoreVal').innerText = Math.floor(score/10);
            road.position.z += moveSpeed; if(road.position.z > 5) road.position.z = 0;

            // Анимация бега
            const t = Date.now() * 0.01;
            if(data.selected !== 'droid') {
                const m = models[data.selected];
                m.children[2].rotation.x = Math.sin(t*1.5)*0.8;
                m.children[3].rotation.x = -Math.sin(t*1.5)*0.8;
                if(m.children[4]) m.children[4].rotation.x = -Math.sin(t*1.5)*0.5;
                if(m.children[5]) m.children[5].rotation.x = Math.sin(t*1.5)*0.5;
            }

            playerGroup.position.x = THREE.MathUtils.lerp(playerGroup.position.x, [-3.5, 0, 3.5][currentLane], 0.15);
            
            let groundY = 0;
            const pBox = new THREE.Box3().setFromObject(playerGroup);

            obstacles.forEach((obj, i) => {
                obj.position.z += moveSpeed;
                const oBox = new THREE.Box3().setFromObject(obj);

                if (pBox.intersectsBox(oBox)) {
                    let onTop = false;
                    obj.children.forEach(c => {
                        if(c.isPlatform && playerGroup.position.y > 1.5) { groundY = 2.8; onTop = true; }
                    });

                    if((obj.isHurt || !onTop && obj.children.length > 1) && !onTop) {
                        if (skateActive) {
                            skateActive = false; skateMesh.visible = false;
                            document.getElementById('skateTimer').style.display = 'none';
                            scene.remove(obj); obstacles.splice(i, 1);
                        } else {
                            isPlaying = false; showScreen('screen-main');
                        }
                    }
                }
                if (obj.position.z > 20) { scene.remove(obj); obstacles.splice(i, 1); }
            });

            coins.forEach((c, i) => {
                c.position.z += moveSpeed; c.rotation.y += 0.05;
                if (pBox.intersectsBox(new THREE.Box3().setFromObject(c))) {
                    data.coins++; save(); scene.remove(c); coins.splice(i, 1);
                } else if (c.position.z > 20) { scene.remove(c); coins.splice(i, 1); }
            });

            playerGroup.position.y += yVel;
            if (playerGroup.position.y > groundY) yVel -= 0.015;
            else { playerGroup.position.y = groundY; yVel = 0; isJumping = false; }

            if (skateActive) {
                skateTime -= 0.016;
                document.getElementById('skateSec').innerText = Math.ceil(skateTime);
                if (skateTime <= 0) { skateActive = false; skateMesh.visible = false; document.getElementById('skateTimer').style.display = 'none'; }
            }

            spawn();
            renderer.render(scene, camera);
        }

        window.save = () => { localStorage.setItem('cyb_run_orig', JSON.stringify(data)); updateUI(); }
        window.load = () => { const s = localStorage.getItem('cyb_run_orig'); if(s) data = JSON.parse(s); updateUI(); }
        window.updateUI = () => {
            document.getElementById('coinVal').innerText = data.coins;
            document.getElementById('shopCoinVal').innerText = data.coins;
            document.getElementById('skateVal').innerText = data.skates;
            document.getElementById('b-droid').innerText = data.unlocked.droid ? "КУПЛЕНО" : "КУПИТЬ";
            document.getElementById('b-spike').innerText = data.unlocked.spike ? "КУПЛЕНО" : "КУПИТЬ";
        }
        window.showScreen = (id) => {
            document.querySelectorAll('.overlay').forEach(s => s.style.display = 'none');
            if(id !== 'none') document.getElementById(id).style.display = 'flex';
        }
        window.buySkate = () => { if(data.coins >= 1) { data.coins--; data.skates++; save(); } }
        window.buyChar = (id, cost) => { if(data.coins >= cost && !data.unlocked[id]) { data.coins -= cost; data.unlocked[id] = true; save(); } }
        window.openCharMenu = () => {
            const list = document.getElementById('char-list'); list.innerHTML = "";
            Object.keys(data.unlocked).forEach(k => {
                if(data.unlocked[k]) {
                    const d = document.createElement('div');
                    d.className = `char-item ${data.selected === k ? 'selected' : ''}`;
                    d.innerText = k.toUpperCase();
                    d.onclick = () => { data.selected = k; save(); openCharMenu(); };
                    list.appendChild(d);
                }
            });
            showScreen('screen-chars');
        }
        window.startGame = () => {
            showScreen('none'); isPlaying = true;
            score = 0; speed = 0.5; currentLane = 1; skateActive = false; skateMesh.visible = false;
            playerGroup.position.set(0,0,0);
            Object.keys(models).forEach(k => models[k].visible = (k === data.selected));
            obstacles.forEach(o => scene.remove(o)); obstacles = [];
            coins.forEach(c => scene.remove(c)); coins = [];
        }

        let tX, tY;
        window.ontouchstart = e => {
            const now = Date.now();
            if (now - lastTap < 300 && isPlaying && data.skates > 0 && !skateActive) {
                data.skates--; skateActive = true; skateTime = 30; skateMesh.visible = true;
                document.getElementById('skateTimer').style.display = 'block'; save();
            }
            lastTap = now; tX = e.touches[0].clientX; tY = e.touches[0].clientY;
        }
        window.ontouchend = e => {
            if(!isPlaying) return;
            const dx = e.changedTouches[0].clientX - tX, dy = e.changedTouches[0].clientY - tY;
            if(Math.abs(dx) > Math.abs(dy)) {
                if(dx > 30 && currentLane < 2) currentLane++;
                if(dx < -30 && currentLane > 0) currentLane--;
            } else if(dy < -30 && !isJumping) { yVel = 0.3; isJumping = true; }
        }

        load(); buildModels(); animate();
    </script>
</body>
</html>
