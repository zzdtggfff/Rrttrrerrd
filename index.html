<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cyber Runner: Shop & Spikes</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        canvas { display: block; }
        #ui { position: absolute; top: 15px; left: 15px; color: #00ffcc; z-index: 5; pointer-events: none; }
        .stat { font-size: 20px; font-weight: bold; text-shadow: 2px 2px #000; }
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; z-index: 10; }
        .menu-card { background: #111; padding: 25px; border-radius: 20px; border: 2px solid #00ffcc; text-align: center; max-width: 90%; }
        .shop-grid { display: flex; gap: 15px; margin: 20px 0; justify-content: center; }
        .item { padding: 15px; border: 2px solid #444; border-radius: 12px; cursor: pointer; width: 100px; transition: 0.3s; }
        .item.selected { border-color: #00ffcc; background: #003322; }
        .item.locked { opacity: 0.6; position: relative; }
        .price { font-size: 14px; color: #ffcc00; display: block; margin-top: 5px; }
        button#startBtn { padding: 15px 40px; font-size: 20px; background: #00ffcc; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="ui">
        <div class="stat">SCORE: <span id="scoreVal">0</span></div>
        <div class="stat">COINS: <span id="coinVal">0</span></div>
    </div>

    <div id="overlay">
        <div class="menu-card">
            <h1 id="mTitle">CYBER SHOP</h1>
            <div class="shop-grid">
                <div class="item selected" id="i1">
                    <b>РОБОТ</b>
                    <span class="price">FREE</span>
                </div>
                <div class="item" id="i2">
                    <b>ДРОИД</b>
                    <span class="price" id="dPrice">5 COINS</span>
                </div>
            </div>
            <button id="startBtn">START MISSION</button>
        </div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        const LANE_WIDTH = 3.5;
        const LANES = [-LANE_WIDTH, 0, LANE_WIDTH];
        let speed = 0.5, isPlaying = false, score = 0, totalCoins = 0;
        let currentLane = 1, isJumping = false, yVel = 0, gravity = 0.01;
        let lastSpawn = 0, selectedSkin = 1, unlockedDroid = false;

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x02050a);
        scene.fog = new THREE.Fog(0x02050a, 20, 100);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 7, 12);
        camera.lookAt(0, 2, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        const light = new THREE.DirectionalLight(0x00ffcc, 1);
        light.position.set(5, 10, 5);
        scene.add(light);

        // --- ПЕРСОНАЖИ ---
        const playerGroup = new THREE.Group();
        const hero1 = new THREE.Group(); // Robot
        const hero2 = new THREE.Group(); // Droid with eyes

        // Hero 1 Build
        const m = new THREE.MeshStandardMaterial({color: 0x444444});
        const torso = new THREE.Mesh(new THREE.BoxGeometry(0.7, 0.9, 0.4), m); torso.position.y = 1.3;
        const legL = new THREE.Mesh(new THREE.BoxGeometry(0.25, 0.7, 0.25), m); legL.position.set(-0.2, 0.5, 0);
        const legR = legL.clone(); legR.position.set(0.2, 0.5, 0);
        hero1.add(torso, legL, legR, new THREE.Mesh(new THREE.BoxGeometry(0.4,0.4,0.4), new THREE.MeshStandardMaterial({color:0x00ffcc})).translateY(2));

        // Hero 2 Build (Droid)
        const dBody = new THREE.Mesh(new THREE.SphereGeometry(0.5, 16, 16), new THREE.MeshStandardMaterial({color: 0x222222}));
        dBody.position.y = 0.8;
        const eyeL = new THREE.Mesh(new THREE.SphereGeometry(0.1, 8, 8), new THREE.MeshBasicMaterial({color: 0x00ffcc}));
        eyeL.position.set(-0.2, 1, 0.35);
        const eyeR = eyeL.clone(); eyeR.position.x = 0.2;
        hero2.add(dBody, eyeL, eyeR);

        playerGroup.add(hero1, hero2);
        scene.add(playerGroup);

        // --- ОБЪЕКТЫ ---
        let objects = [], coins = [], ground;
        ground = new THREE.Mesh(new THREE.PlaneGeometry(25, 1000), new THREE.MeshStandardMaterial({color: 0x050505}));
        ground.rotation.x = -Math.PI/2;
        scene.add(ground);

        function spawn() {
            // Прогрессивная сложность: интервал уменьшается со счетом
            const spawnInterval = Math.max(300, 800 - (score / 10));
            if(Date.now() - lastSpawn < spawnInterval / (speed * 1.5)) return;
            lastSpawn = Date.now();

            const lane = LANES[Math.floor(Math.random()*3)];
            const r = Math.random();

            if(r < 0.25) { // Горка + Платформы + Шипы
                const group = new THREE.Group();
                const ramp = new THREE.Mesh(new THREE.BoxGeometry(3, 0.5, 8), new THREE.MeshStandardMaterial({color: 0x0066ff}));
                ramp.rotation.x = 0.25; ramp.position.set(0, 1, 0);
                const p1 = new THREE.Mesh(new THREE.BoxGeometry(3, 0.5, 10), new THREE.MeshStandardMaterial({color: 0x00ffff}));
                p1.position.set(0, 2.2, -10);
                const p2 = p1.clone(); p2.position.z = -25;
                
                // Шипы под платформами
                const spikes = new THREE.Mesh(new THREE.BoxGeometry(3.2, 0.8, 30), new THREE.MeshStandardMaterial({color: 0xff0000}));
                spikes.position.set(0, 0.4, -15);
                spikes.isBarrier = true;

                group.add(ramp, p1, p2, spikes);
                group.position.set(lane, 0, -100);
                group.isPlatform = true;
                scene.add(group); objects.push(group);
            } else if (r < 0.85) { // Обычные блоки (часто)
                const obs = new THREE.Mesh(new THREE.BoxGeometry(2.8, 1.8, 1), new THREE.MeshStandardMaterial({color: 0xff0044}));
                obs.position.set(lane, 0.9, -100);
                obs.isBarrier = true;
                scene.add(obs); objects.push(obs);
            } else {
                const c = new THREE.Mesh(new THREE.CylinderGeometry(0.4,0.4,0.1,12), new THREE.MeshStandardMaterial({color:0xffff00}));
                c.rotation.x = Math.PI/2; c.position.set(lane, 1.2, -100);
                scene.add(c); coins.push(c);
            }
        }

        // --- ЛОГИКА ---
        function animate() {
            requestAnimationFrame(animate);
            if(!isPlaying) return;

            speed += 0.0001;
            score += 1;
            document.getElementById('scoreVal').innerText = Math.floor(score/10);

            // Анимация ног Робота
            if(selectedSkin === 1) {
                legL.rotation.x = Math.sin(Date.now()*0.01) * 0.8;
                legR.rotation.x = -Math.sin(Date.now()*0.01) * 0.8;
            }

            playerGroup.position.x = THREE.MathUtils.lerp(playerGroup.position.x, LANES[currentLane], 0.18);

            let groundLevel = 0;
            const pBox = new THREE.Box3().setFromObject(playerGroup);

            objects.forEach(obj => {
                obj.position.z += speed;
                if(obj.isPlatform) {
                    const oBox = new THREE.Box3().setFromObject(obj);
                    if(pBox.min.x < oBox.max.x && pBox.max.x > oBox.min.x && pBox.min.z < oBox.max.z && pBox.max.z > oBox.min.z) {
                        obj.children.forEach(c => {
                            if(c.geometry.type === "BoxGeometry" && c.position.y > 0.5) {
                                const cBox = new THREE.Box3().setFromObject(c);
                                if(pBox.min.z < cBox.max.z && pBox.max.z > cBox.min.z) groundLevel = Math.max(groundLevel, c.position.y + 0.1);
                            }
                        });
                    }
                }
                // Проверка столкновений (блоки и шипы)
                if(obj.isBarrier || (obj.isPlatform && groundLevel === 0)) {
                    const bBox = new THREE.Box3().setFromObject(obj);
                    if(pBox.intersectsBox(bBox)) gameOver();
                }
            });

            playerGroup.position.y += yVel;
            if(playerGroup.position.y > groundLevel) yVel -= gravity;
            else { playerGroup.position.y = groundLevel; yVel = 0; isJumping = false; }

            // Если упал с платформы прямо в шипы
            if(playerGroup.position.y < 0.5 && groundLevel > 1) gameOver();

            spawn();

            for(let i=coins.length-1; i>=0; i--) {
                coins[i].position.z += speed;
                if(pBox.intersectsBox(new THREE.Box3().setFromObject(coins[i]))) {
                    totalCoins++;
                    document.getElementById('coinVal').innerText = totalCoins;
                    scene.remove(coins[i]); coins.splice(i,1);
                } else if(coins[i].position.z > 20) { scene.remove(coins[i]); coins.splice(i,1); }
            }
            
            for(let i=objects.length-1; i>=0; i--) if(objects[i].position.z > 25) { scene.remove(objects[i]); objects.splice(i,1); }

            renderer.render(scene, camera);
        }

        function gameOver() {
            isPlaying = false;
            document.getElementById('overlay').style.display = 'flex';
            document.getElementById('mTitle').innerText = "WASTED";
        }

        // --- МАГАЗИН И СТАРТ ---
        const i1 = document.getElementById('i1');
        const i2 = document.getElementById('i2');

        i1.onclick = () => { selectedSkin = 1; i1.classList.add('selected'); i2.classList.remove('selected'); };
        i2.onclick = () => {
            if(unlockedDroid) {
                selectedSkin = 2; i2.classList.add('selected'); i1.classList.remove('selected');
            } else if(totalCoins >= 5) {
                totalCoins -= 5;
                unlockedDroid = true;
                document.getElementById('coinVal').innerText = totalCoins;
                document.getElementById('dPrice').innerText = "UNLOCKED";
                selectedSkin = 2; i2.classList.add('selected'); i1.classList.remove('selected');
            }
        };

        document.getElementById('startBtn').onclick = () => {
            hero1.visible = (selectedSkin === 1);
            hero2.visible = (selectedSkin === 2);
            objects.forEach(o => scene.remove(o)); objects = [];
            coins.forEach(c => scene.remove(c)); coins = [];
            score = 0; speed = 0.5; currentLane = 1;
            playerGroup.position.set(0,0,0);
            document.getElementById('overlay').style.display = 'none';
            isPlaying = true;
        };

        // Управление свайпами
        let tX, tY;
        window.ontouchstart = e => { tX = e.touches[0].clientX; tY = e.touches[0].clientY; };
        window.ontouchend = e => {
            if(!isPlaying) return;
            const dx = e.changedTouches[0].clientX - tX;
            const dy = e.changedTouches[0].clientY - tY;
            if(Math.abs(dx) > Math.abs(dy)) {
                if(dx > 35 && currentLane < 2) currentLane++;
                if(dx < -35 && currentLane > 0) currentLane--;
            } else if(dy < -35 && !isJumping) { yVel = 0.26; isJumping = true; }
        };

        animate();
    </script>
</body>
</html>
